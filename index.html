<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Live Workspace | Stable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --primary: #10b981; --bg: #f8fafc; --text: #0f172a; }
    body { font-family: sans-serif; background: #f1f5f9; padding: 20px; max-width: 500px; margin: auto; }
    .app-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .todo-item { border-left: 5px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fff; position: relative; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .priority-3 { border-left-color: #ef4444; background: #fff1f2; }
    .priority-2 { border-left-color: #3b82f6; }
    .priority-1 { border-left-color: #94a3b8; }
    .completed { text-decoration: line-through; opacity: 0.5; }
    #presence-list { display: flex; gap: 5px; margin-bottom: 10px; }
    .user-pill { font-size: 10px; padding: 4px 8px; border-radius: 10px; background: #eee; }
    input, select { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
    .btn-primary { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; cursor: pointer; border-radius: 5px; font-weight: bold; }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; display: none; }
  </style>
</head>
<body>

  <div id="presence-list"></div>

  <div class="app-card">
    <div id="auth-ui">
      <h2>Workspace</h2>
      <div id="signup-box" style="display:none;"><input type="text" id="reg-name" placeholder="Name"></div>
      <input type="email" id="log-email" placeholder="Email">
      <input type="password" id="log-pass" placeholder="Password">
      <button class="btn-primary" id="btn-do-auth">Login</button>
      <p style="text-align:center; font-size:12px;"><a href="#" id="sw-auth">Switch to Sign Up</a></p>
    </div>

    <div id="todo-app" style="display:none;">
      <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:10px;">
        <b id="who-am-i"></b>
        <button onclick="supabase.auth.signOut().then(()=>location.reload())">Logout</button>
      </div>
      <form id="todo-form">
        <input type="text" id="t-input" placeholder="New task..." required>
        <select id="t-prio"><option value="1">Low</option><option value="2">Med</option><option value="3">High</option></select>
        <button class="btn-primary">Add Task</button>
      </form>
      <div id="todo-list" style="margin-top:20px;"></div>
    </div>
  </div>
  <div id="toast"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
    const supabase = createClient('https://hdzmbngzplkgkchmxfwu.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhkem1ibmd6cGxrZ2tjaG14Znd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzgyNzc3NjQsImV4cCI6MTk5Mzg1Mzc2NH0.ogb5FZ_nfUdIcobdas9EFm7u8vOs8-_RB2CB4MxLMAU');
    window.supabase = supabase;

    let _uName = "User", _isReg = false, _chan;

    // UI Toggles
    document.getElementById('sw-auth').onclick = (e) => {
      _isReg = !_isReg;
      document.getElementById('signup-box').style.display = _isReg ? 'block' : 'none';
      e.target.innerText = _isReg ? 'Switch to Login' : 'Switch to Sign Up';
    };

    document.getElementById('btn-do-auth').onclick = async () => {
      const email = document.getElementById('log-email').value;
      const pass = document.getElementById('log-pass').value;
      if(_isReg) {
        const name = document.getElementById('reg-name').value;
        await supabase.auth.signUp({ email, password: pass, options: { data: { display_name: name } } });
        alert("Check email or try logging in!");
      } else {
        const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if(error) alert(error.message);
      }
    };

    // App Logic
    supabase.auth.onAuthStateChange((evt, session) => {
      if(session) {
        _uName = session.user.user_metadata?.display_name || session.user.email.split('@')[0];
        document.getElementById('auth-ui').style.display = 'none';
        document.getElementById('todo-app').style.display = 'block';
        document.getElementById('who-am-i').innerText = "Hello, " + _uName;
        load();
        initLive();
      }
    });

    async function load() {
      const { data, error } = await supabase.from('todos').select('*').order('priority', {ascending: false});
      if(error) console.error("Load Error:", error);
      const list = document.getElementById('todo-list');
      list.innerHTML = (data || []).map(t => `
        <div class="todo-item priority-${t.priority}" data-id="${t.id}">
          <input type="checkbox" ${t.is_complete ? 'checked' : ''} onclick="updateTask(${t.id}, {is_complete: this.checked})">
          <span class="${t.is_complete ? 'completed' : ''}">${t.task}</span>
          <div style="font-size:9px; color:gray; margin-top:5px;">By: ${t.created_by_name || 'Team'}</div>
          <button onclick="deleteTask(${t.id})" style="position:absolute; top:5px; right:5px;">&times;</button>
        </div>
      `).join('');
    }

    window.updateTask = async (id, obj) => { await supabase.from('todos').update(obj).eq('id', id); };
    window.deleteTask = async (id) => { await supabase.from('todos').delete().eq('id', id); };

    document.getElementById('todo-form').onsubmit = async (e) => {
      e.preventDefault();
      const val = document.getElementById('t-input').value;
      const prio = document.getElementById('t-prio').value;
      await supabase.from('todos').insert([{ task: val, priority: prio, created_by_name: _uName }]);
      document.getElementById('t-input').value = '';
    };

    function initLive() {
      _chan = supabase.channel('stable-sync').on('postgres_changes', { event:'*', schema:'public', table:'todos' }, load).subscribe();
    }
  </script>
</body>
</html>
