<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Secure My Todos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; background:#f9fafb; }
    h1 { color: #10b981; text-align: center; }
    
    /* Auth Styling */
    #auth-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
    .auth-input-group { display: flex; flex-direction: column; gap: 10px; }
    .auth-buttons { display: flex; gap: 10px; margin-top: 10px; }
    
    /* Todo Styling */
    #form { display: flex; gap: 10px; margin: 30px 0; }
    input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    button { cursor: pointer; border-radius: 8px; border: none; font-weight: bold; transition: opacity 0.2s; }
    button:hover { opacity: 0.8; }
    .btn-primary { background: #10b981; color: white; padding: 12px 24px; }
    .btn-outline { background: #3b82f6; color: white; padding: 8px 16px; }
    .btn-danger { background: #ef4444; color: white; padding: 5px 10px; }
  </style>
</head>
<body>

  <h1>My Secure Todos</h1>

  <div id="auth-container">
    <div id="logged-out-ui">
      <h3>Login or Sign Up</h3>
      <div class="auth-input-group">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
      </div>
      <div class="auth-buttons">
        <button class="btn-outline" onclick="login()">Login</button>
        <button class="btn-outline" style="background:#6b7280" onclick="signUp()">Sign Up</button>
      </div>
    </div>

    <div id="logged-in-ui" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span id="user-display" style="font-weight: bold; color: #4b5563;"></span>
        <button class="btn-danger" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div id="todo-app" style="display: none;">
    <form id="form">
      <input type="text" id="todo-input" style="flex:1" placeholder="Add a private task..." required>
      <button class="btn-primary" type="submit">Add</button>
    </form>
    <div id="list"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
    
    const SUPABASE_URL = 'https://hdzmbngzplkgkchmxfwu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhkem1ibmd6cGxrZ2tjaG14Znd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzgyNzc3NjQsImV4cCI6MTk5Mzg1Mzc2NH0.ogb5FZ_nfUdIcobdas9EFm7u8vOs8-_RB2CB4MxLMAU';

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    window.supabase = supabase;

    // --- Authentication ---
    window.signUp = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) alert(error.message);
      else alert("Sign up successful! Check your email for a confirmation link.");
    };

    window.login = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) alert(error.message);
    };

    window.logout = async () => {
      await supabase.auth.signOut();
    };

    // --- App Logic ---
    const todoApp = document.getElementById('todo-app');
    const loggedInUI = document.getElementById('logged-in-ui');
    const loggedOutUI = document.getElementById('logged-out-ui');
    const userDisplay = document.getElementById('user-display');

    // Monitor Auth State
    supabase.auth.onAuthStateChange((event, session) => {
      if (session) {
        loggedInUI.style.display = 'block';
        loggedOutUI.style.display = 'none';
        todoApp.style.display = 'block';
        userDisplay.innerText = session.user.email;
        load();
      } else {
        loggedInUI.style.display = 'none';
        loggedOutUI.style.display = 'block';
        todoApp.style.display = 'none';
        document.getElementById('list').innerHTML = '';
      }
    });

    window.load = async function load() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data, error } = await supabase
        .from('todos')
        .select('*')
        .eq('user_id', user.id) // Security: Only fetch my todos
        .order('id', { ascending: false });
      
      if (error) {
        console.error(error);
        return;
      }

      document.getElementById('list').innerHTML = data.map(t => `
        <div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #eee">
          <input type="checkbox" ${t.is_complete ? 'checked' : ''} 
                 onchange="supabase.from('todos').update({is_complete:this.checked}).eq('id',${t.id}).then(load)">
          <span style="flex:1;${t.is_complete ? 'text-decoration:line-through;color:#888' : ''}">${t.task}</span>
          <button onclick="supabase.from('todos').delete().eq('id',${t.id}).then(load)" 
                  style="color:red; background:none; border:none; cursor:pointer;">Delete</button>
        </div>`).join('');
    }

    document.getElementById('form').onsubmit = async (e) => {
      e.preventDefault();
      const input = document.getElementById('todo-input');
      const { data: { user } } = await supabase.auth.getUser();

      if (user && input.value) {
        const { error } = await supabase.from('todos').insert([{ 
          task: input.value, 
          is_complete: false,
          user_id: user.id // Ties the row to the logged-in user
        }]);

        if (error) alert(error.message);
        else {
          input.value = '';
          load();
        }
      }
    };
  </script>
</body>
</html>
